<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - COUNTDOWNS</title>
    <meta name="description" content="A smart countdown manager for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <style>
        /* --- FONT & BASE STYLING --- */
        :root {
            --menu-bg: #000000;
            --menu-border: #333;
            --menu-text: #d1d5db;
            --menu-item-hover-bg: #2a2a2a;
            --tab-active-bg: rgba(79, 70, 229, 0.1);
            --tab-active-border: #4f46e5;
            --tab-active-text: #4f46e5;
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: var(--navbar-bg); 
            color: var(--menu-text); 
            transition: all 0.3s ease;
            font-size: 16px;
            overflow-x: hidden;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* --- BUTTONS & TOOLBAR --- */
        .btn-toolbar-style {
            background: var(--menu-bg);
            border: 1px solid var(--menu-border);
            border-radius: 0.75rem;
            color: var(--menu-text);
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-toolbar-style:hover {
            background-color: var(--menu-bg);
            border-color: #fff;
            color: #ffffff;
        }
        
        .btn-toolbar-style.btn-primary-override {
            background-color: var(--tab-active-bg);
            border: 1px solid var(--tab-active-border);
            color: var(--tab-active-text);
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }

        .btn-secondary-override {
            background: var(--menu-bg);
            border: 1px solid var(--menu-border);
            color: var(--menu-text);
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-secondary-override:hover {
            background-color: var(--menu-item-hover-bg);
            border-color: #555;
            color: #ffffff;
        }

        /* --- DROPDOWN --- */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--menu-bg);
            border: 1px solid var(--menu-border);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1010;
            min-width: 200px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        .dropdown-item {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: var(--menu-text);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.15s, color 0.15s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dropdown-item:hover {
            background-color: var(--menu-item-hover-bg);
            color: #ffffff;
        }

        /* --- MAIN CONTENT --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        #countdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* --- CARD STYLING --- */
        .countdown-card {
            background-color: var(--menu-bg);
            border: 1px solid var(--navbar-border);
            border-radius: 1rem;
            padding: 1.5rem;
            padding-bottom: 3.5rem; 
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: border-color 0.2s;
            position: relative;
        }
        .countdown-card:hover {
            border-color: #333;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .card-title {
            font-size: 1.2rem;
            color: #fff;
        }
        .card-meta {
            font-size: 0.8rem;
            color: #707070;
        }
        .time-display {
            font-family: 'Roboto', sans-serif;
            font-size: 1.5rem;
            color: var(--tab-active-text);
            font-weight: 300;
        }
        .detail-display {
            font-size: 0.85rem;
            color: #9ca3af;
            line-height: 1.4;
        }
        .delete-btn {
            position: absolute;
            bottom: 1rem; 
            right: 1rem;
            color: #707070;
            cursor: pointer;
            opacity: 0.8; 
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-size: 1rem;
            line-height: 1;
            width: 2rem; 
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .countdown-card:hover .delete-btn {
            opacity: 1;
        }
        .delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.15); 
            border: 1px solid rgba(239, 68, 68, 0.5); 
            color: #ef4444; 
            opacity: 1;
        }

        /* --- MODAL STYLING (16:9) --- */
        #modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(7, 7, 7, 0.85);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        #countdown-modal {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 20px;
            width: 80vw;
            max-width: 1000px;
            aspect-ratio: 16 / 9;
            display: flex;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .modal-left {
            width: 45%;
            padding: 2rem;
            border-right: 1px solid #1a1a1a;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }
        .modal-right {
            width: 55%;
            background: #050505;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        label {
            font-size: 0.85rem;
            color: #707070;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .custom-input-container {
            background: #151515;
            border: 1px solid #333;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #fff;
            outline: none;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: border-color 0.2s;
            font-size: 1rem;
        }
        .custom-input-container:hover {
            border-color: #555;
        }
        .custom-input-container.focus-ring {
            border-color: var(--tab-active-border);
        }
        .custom-input-container span {
            font-weight: 500;
        }
        
        select {
            background: #151515;
            border: 1px solid #333;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #fff;
            outline: none;
            font-family: inherit;
        }
        select:focus {
            border-color: var(--tab-active-border);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .day-checkbox {
            display: none;
        }
        .day-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid #333;
            color: #707070;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .day-checkbox:checked + .day-label {
            background: var(--tab-active-bg);
            border-color: var(--tab-active-border);
            color: var(--tab-active-text);
        }

        #preview-big-time {
            font-size: 2.5rem;
            font-weight: 300;
            color: #fff;
            margin-bottom: 1rem;
            font-family: 'Roboto', sans-serif;
        }
        #preview-details {
            font-size: 1rem;
            color: #707070;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            text-align: left;
        }
        .preview-stat {
            background: #111;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #222;
        }
        .preview-stat strong {
            color: var(--tab-active-text);
        }

        .modal-actions {
            margin-top: auto;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* --- CUSTOM PICKER MODALS STYLING --- */
        .picker-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3000; /* Higher than main modal */
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .picker-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .picker-modal {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            min-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Date Picker Specifics */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .calendar-nav-btn {
            background: transparent;
            border: 1px solid #333;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-nav-btn:hover {
            background: #222;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day-name {
            color: #707070;
            font-size: 0.75rem;
            padding-bottom: 0.5rem;
        }
        .calendar-day {
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.3rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: #ccc;
        }
        .calendar-day:hover {
            background: #222;
            color: #fff;
        }
        .calendar-day.empty {
            cursor: default;
            pointer-events: none;
        }
        .calendar-day.selected {
            background: var(--tab-active-bg);
            border: 1px solid var(--tab-active-border);
            color: var(--tab-active-text);
        }
        .calendar-day.today {
            border: 1px solid #444;
        }

        /* Time Picker Specifics (12H Format) */
        .time-picker-content {
            display: flex;
            gap: 0.5rem;
            height: 200px;
        }
        .time-column {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #222;
            border-radius: 0.5rem;
            background: #080808;
        }
        .time-option {
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            font-size: 1.1rem;
            color: #888;
        }
        .time-option:hover {
            background: #1a1a1a;
            color: #fff;
        }
        .time-option.selected {
            background: var(--tab-active-bg);
            color: var(--tab-active-text);
        }
        .picker-title {
            text-align: center;
            color: #707070;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 33%;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #040404; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
    
</head>
<body class="min-h-screen">
    
    <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
        <h1 class="text-2xl font-bold text-white">4SP Countdowns</h1>
        
        <div class="flex items-center gap-2">
            <div id="add-menu-container" class="relative">
                <button id="add-menu-btn" class="btn-toolbar-style btn-primary-override">
                    <i class="fa-solid fa-plus"></i> <span>Add Countdown</span>
                </button>

                <div id="add-dropdown" class="dropdown-menu hidden">
                    <div class="dropdown-header">Type</div>
                    <div id="btn-add-one-time" class="dropdown-item">
                        <i class="fa-solid fa-hourglass-end w-5"></i> One Time
                    </div>
                    <div id="btn-add-repeating" class="dropdown-item">
                        <i class="fa-solid fa-rotate w-5"></i> Repeating
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="page-content">
        <div id="countdown-grid">
            </div>
        <div id="empty-state" class="hidden flex-col items-center justify-center mt-20 text-[#333]">
            <i class="fa-solid fa-clock text-6xl mb-4"></i>
            <p>No countdowns yet.</p>
        </div>
    </div>

    <div id="modal-overlay">
        <div id="countdown-modal">
            <div class="modal-left">
                <h2 id="modal-title-text" class="text-xl text-white mb-2">New Countdown</h2>
                
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="input-title" placeholder="e.g. Project Launch" maxlength="40" 
                           class="bg-[#151515] border border-[#333] rounded-lg p-3 text-white outline-none focus:border-indigo-500">
                </div>

                <div class="flex gap-4">
                    <div class="form-group flex-1">
                        <label>Date</label>
                        <div id="date-display-container" class="custom-input-container relative">
                            <span id="date-display"></span>
                            <i class="fa-solid fa-calendar-day text-[#707070]"></i>
                             <input type="hidden" id="input-date">
                        </div>
                    </div>
                    <div class="form-group flex-1">
                        <label>Time</label>
                        <div id="time-display-container" class="custom-input-container relative">
                            <span id="time-display"></span>
                            <i class="fa-solid fa-clock text-[#707070]"></i>
                            <input type="hidden" id="input-time" value="12:00">
                        </div>
                    </div>
                </div>

                <div id="frequency-section" class="hidden">
                    <div class="form-group">
                        <label>Frequency Pattern</label>
                        <select id="input-freq-type" class="bg-[#151515] border border-[#333] rounded-lg p-3 text-white outline-none focus:border-indigo-500">
                            <option value="daily">Daily</option>
                            <option value="weekly">Specific Days (Weekly)</option>
                            <option value="monthly">Monthly (Same Day)</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>

                    <div id="days-selector" class="form-group hidden mt-2">
                        <label>Repeats On</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" class="day-checkbox" value="0"><span class="day-label">S</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="1"><span class="day-label">M</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="2"><span class="day-label">T</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="3"><span class="day-label">W</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="4"><span class="day-label">T</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="5"><span class="day-label">F</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="6"><span class="day-label">S</span></label>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="btn-cancel-modal" class="btn-secondary-override">Cancel</button>
                    <button id="btn-save-countdown" class="btn-toolbar-style btn-primary-override">Create Countdown</button>
                </div>
            </div>

            <div class="modal-right">
                <div class="absolute top-4 right-4 text-xs text-[#555]">PREVIEW</div>
                <h3 id="preview-title" class="text-2xl text-white mb-4 font-light">New Event</h3>
                <div id="preview-big-time">00:00:00</div>
                
                <div id="preview-details">
                    <div class="preview-stat">Decades: <strong id="p-dec">0</strong></div>
                    <div class="preview-stat">Years: <strong id="p-yrs">0</strong></div>
                    <div class="preview-stat">Months: <strong id="p-mos">0</strong></div>
                    <div class="preview-stat">Weeks: <strong id="p-wks">0</strong></div>
                    <div class="preview-stat">Days: <strong id="p-days">0</strong></div>
                    <div class="preview-stat">Target: <span id="p-date-str" class="text-xs">---</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="date-picker-overlay" class="picker-overlay">
        <div class="picker-modal">
            <div class="calendar-header">
                <button id="cal-prev" class="calendar-nav-btn"><i class="fa-solid fa-chevron-left"></i></button>
                <div id="cal-month-year" class="font-semibold text-white">November 2025</div>
                <button id="cal-next" class="calendar-nav-btn"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-day-name">S</div>
                <div class="calendar-day-name">M</div>
                <div class="calendar-day-name">T</div>
                <div class="calendar-day-name">W</div>
                <div class="calendar-day-name">T</div>
                <div class="calendar-day-name">F</div>
                <div class="calendar-day-name">S</div>
            </div>
            <div id="calendar-days" class="calendar-grid">
                </div>
            <div class="flex justify-end mt-2">
                <button id="btn-cancel-date" class="text-sm text-gray-500 hover:text-white">Cancel</button>
            </div>
        </div>
    </div>

    <div id="time-picker-overlay" class="picker-overlay">
        <div class="picker-modal">
            <div class="flex justify-around w-full">
                <div class="picker-title">Hr</div>
                <div class="picker-title">Min</div>
                <div class="picker-title">Pd</div>
            </div>
            <div class="time-picker-content">
                <div id="time-col-hours" class="time-column">
                    </div>
                <div id="time-col-minutes" class="time-column">
                    </div>
                <div id="time-col-period" class="time-column">
                    </div>
            </div>
            <div class="flex justify-end gap-4 mt-2">
                <button id="btn-cancel-time" class="text-sm text-gray-500 hover:text-white">Cancel</button>
                <button id="btn-confirm-time" class="btn-secondary-override text-sm py-1 px-3">Set Time</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE & CONFIG ---
        const MAX_YEARS_FUTURE = 15;
        let appState = {
            countdowns: [] 
        };

        // --- DOM ELEMENTS ---
        const addMenuBtn = document.getElementById('add-menu-btn');
        const addDropdown = document.getElementById('add-dropdown');
        const grid = document.getElementById('countdown-grid');
        const emptyState = document.getElementById('empty-state');
        
        // Main Modal Elements
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitleText = document.getElementById('modal-title-text');
        const btnCancel = document.getElementById('btn-cancel-modal');
        const btnSave = document.getElementById('btn-save-countdown');
        
        // Form Inputs
        const inpTitle = document.getElementById('input-title');
        const inpDate = document.getElementById('input-date'); // hidden YYYY-MM-DD
        const inpTime = document.getElementById('input-time'); // hidden HH:MM (24h)
        const freqSection = document.getElementById('frequency-section');
        const inpFreqType = document.getElementById('input-freq-type');
        const daysSelector = document.getElementById('days-selector');
        
        // Trigger Elements
        const dateDisplay = document.getElementById('date-display');
        const dateContainer = document.getElementById('date-display-container');
        const timeDisplay = document.getElementById('time-display');
        const timeContainer = document.getElementById('time-display-container');

        // Preview Elements
        const pTitle = document.getElementById('preview-title');
        const pBigTime = document.getElementById('preview-big-time');
        const pDec = document.getElementById('p-dec');
        const pYrs = document.getElementById('p-yrs');
        const pMos = document.getElementById('p-mos');
        const pWks = document.getElementById('p-wks');
        const pDays = document.getElementById('p-days');
        const pDateStr = document.getElementById('p-date-str');

        let currentModalType = 'one-time'; 

        // --- PICKER LOGIC START ---

        // Date Picker Variables
        const datePickerOverlay = document.getElementById('date-picker-overlay');
        const calMonthYear = document.getElementById('cal-month-year');
        const calDaysContainer = document.getElementById('calendar-days');
        const btnCalPrev = document.getElementById('cal-prev');
        const btnCalNext = document.getElementById('cal-next');
        let pickerDate = new Date(); 

        // Time Picker Variables
        const timePickerOverlay = document.getElementById('time-picker-overlay');
        const timeColHours = document.getElementById('time-col-hours');
        const timeColMinutes = document.getElementById('time-col-minutes');
        const timeColPeriod = document.getElementById('time-col-period');
        
        let pickerHour = 12;  // 1-12
        let pickerMinute = 0; // 0-59
        let pickerPeriod = 'AM'; // AM or PM

        function initPickers() {
            // Init Hours (1-12)
            for(let h=1; h<=12; h++) {
                const div = document.createElement('div');
                div.className = 'time-option';
                div.textContent = h; // No padStart for single digit hours usually, but kept simple
                div.dataset.val = h;
                div.onclick = () => {
                    pickerHour = h;
                    renderTimePicker();
                };
                timeColHours.appendChild(div);
            }
            // Init Minutes (00-59)
            for(let m=0; m<60; m++) {
                const div = document.createElement('div');
                div.className = 'time-option';
                div.textContent = String(m).padStart(2, '0');
                div.dataset.val = m;
                div.onclick = () => {
                    pickerMinute = m;
                    renderTimePicker();
                };
                timeColMinutes.appendChild(div);
            }
            // Init Period (AM/PM)
            ['AM', 'PM'].forEach(p => {
                const div = document.createElement('div');
                div.className = 'time-option';
                div.textContent = p;
                div.dataset.val = p;
                div.onclick = () => {
                    pickerPeriod = p;
                    renderTimePicker();
                };
                timeColPeriod.appendChild(div);
            });

            // Event Listeners for Date Picker
            btnCalPrev.addEventListener('click', () => {
                pickerDate.setMonth(pickerDate.getMonth() - 1);
                renderCalendar();
            });
            btnCalNext.addEventListener('click', () => {
                pickerDate.setMonth(pickerDate.getMonth() + 1);
                renderCalendar();
            });
            document.getElementById('btn-cancel-date').addEventListener('click', () => {
                datePickerOverlay.classList.remove('active');
            });

            // Event Listeners for Time Picker
            document.getElementById('btn-cancel-time').addEventListener('click', () => {
                timePickerOverlay.classList.remove('active');
            });
            document.getElementById('btn-confirm-time').addEventListener('click', () => {
                // Convert 12H back to 24H for storage
                let hour24 = pickerHour;
                if (pickerPeriod === 'PM' && hour24 < 12) hour24 += 12;
                if (pickerPeriod === 'AM' && hour24 === 12) hour24 = 0;

                const timeStr24 = `${String(hour24).padStart(2,'0')}:${String(pickerMinute).padStart(2,'0')}`;
                
                inpTime.value = timeStr24;
                // Display pretty 12H time
                timeDisplay.textContent = formatTime12H(hour24, pickerMinute);
                
                timePickerOverlay.classList.remove('active');
                updatePreview();
            });

            // Open Handlers
            dateContainer.addEventListener('click', openDatePicker);
            timeContainer.addEventListener('click', openTimePicker);
        }

        // Helper to show 12H time string
        function formatTime12H(h, m) {
            const period = h >= 12 ? 'PM' : 'AM';
            let h12 = h % 12;
            if (h12 === 0) h12 = 12;
            return `${h12}:${String(m).padStart(2,'0')} ${period}`;
        }

        function openDatePicker() {
            const currentVal = inpDate.value;
            if(currentVal) {
                const parts = currentVal.split('-');
                pickerDate = new Date(parts[0], parts[1]-1, parts[2]);
            } else {
                pickerDate = new Date();
            }
            renderCalendar();
            datePickerOverlay.classList.add('active');
        }

        function renderCalendar() {
            const year = pickerDate.getFullYear();
            const month = pickerDate.getMonth();
            
            const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            calMonthYear.textContent = `${monthNames[month]} ${year}`;
            
            calDaysContainer.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const selectedVal = inpDate.value; // YYYY-MM-DD

            // Empty slots
            for(let i=0; i<firstDay; i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day empty';
                calDaysContainer.appendChild(div);
            }

            // Days
            for(let d=1; d<=daysInMonth; d++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.textContent = d;
                
                const currentStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                if(currentStr === selectedVal) div.classList.add('selected');
                if(today.getFullYear() === year && today.getMonth() === month && today.getDate() === d) {
                    div.classList.add('today');
                }

                div.addEventListener('click', () => {
                    inpDate.value = currentStr;
                    dateDisplay.textContent = formatDisplayDate(currentStr);
                    updatePreview();
                    datePickerOverlay.classList.remove('active');
                });

                calDaysContainer.appendChild(div);
            }
        }

        function openTimePicker() {
            const currentVal = inpTime.value || "12:00";
            const [h, m] = currentVal.split(':').map(Number);
            
            // Convert stored 24h to 12h for picker state
            pickerPeriod = h >= 12 ? 'PM' : 'AM';
            pickerHour = h % 12;
            if(pickerHour === 0) pickerHour = 12;
            pickerMinute = m;

            renderTimePicker();
            timePickerOverlay.classList.add('active');
            
            // Auto scroll
            setTimeout(() => {
                const hEl = timeColHours.querySelector(`div[data-val="${pickerHour}"]`);
                const mEl = timeColMinutes.querySelector(`div[data-val="${pickerMinute}"]`);
                const pEl = timeColPeriod.querySelector(`div[data-val="${pickerPeriod}"]`);
                
                if(hEl) hEl.scrollIntoView({block: "center"});
                if(mEl) mEl.scrollIntoView({block: "center"});
                if(pEl) pEl.scrollIntoView({block: "center"});
            }, 10);
        }

        function renderTimePicker() {
            Array.from(timeColHours.children).forEach(child => {
                child.classList.toggle('selected', parseInt(child.dataset.val) === pickerHour);
            });
            Array.from(timeColMinutes.children).forEach(child => {
                child.classList.toggle('selected', parseInt(child.dataset.val) === pickerMinute);
            });
            Array.from(timeColPeriod.children).forEach(child => {
                child.classList.toggle('selected', child.dataset.val === pickerPeriod);
            });
        }

        // --- PICKER LOGIC END ---

        // --- INDEXED DB LAYER ---
        const idbCountdowns = {
            db: null,
            initDB: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('4spCountdownDB', 1);
                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        if (!this.db.objectStoreNames.contains('data')) {
                            this.db.createObjectStore('data', { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };
                    request.onerror = (e) => reject(e);
                });
            },
            save: function(data) {
                if(!this.db) return;
                const tx = this.db.transaction(['data'], 'readwrite');
                tx.objectStore('data').put({ id: 'main', countdowns: data });
            },
            load: function() {
                return new Promise((resolve) => {
                    if(!this.db) resolve(null);
                    const tx = this.db.transaction(['data'], 'readonly');
                    const req = tx.objectStore('data').get('main');
                    req.onsuccess = (e) => resolve(e.target.result ? e.target.result.countdowns : []);
                    req.onerror = () => resolve([]);
                });
            }
        };

        // --- LOGIC & HELPERS ---

        function formatDisplayDate(dateString) {
            if (!dateString) return 'Select Date';
            try {
                const parts = dateString.split('-');
                const date = new Date(parts[0], parts[1]-1, parts[2]);
                return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            } catch {
                return dateString;
            }
        }

        function getDuration(target) {
            const now = new Date();
            let diff = target - now;

            if (diff <= 0) return { passed: true };

            const msInDecade = 31556952000 * 10;
            const msInYear = 31556952000;
            const msInMonth = 2629746000;
            const msInWeek = 604800000;
            const msInDay = 86400000;
            const msInHour = 3600000;
            const msInMinute = 60000;
            const msInSecond = 1000;

            const decades = Math.floor(diff / msInDecade);
            let remainder = diff % msInDecade;

            const years = Math.floor(remainder / msInYear);
            remainder %= msInYear;

            const months = Math.floor(remainder / msInMonth);
            remainder %= msInMonth;
            
            const weeks = Math.floor(remainder / msInWeek);
            remainder %= msInWeek;
            
            const days = Math.floor(remainder / msInDay);
            remainder %= msInDay;
            
            const hours = Math.floor(remainder / msInHour);
            remainder %= msInHour;

            const minutes = Math.floor(remainder / msInMinute);
            remainder %= msInMinute;
            
            const seconds = Math.floor(remainder / msInSecond);

            return {
                passed: false,
                decades, years, months, weeks, days, hours, minutes, seconds
            };
        }

        function getNextOccurrence(item) {
            const now = new Date();
            const [tHours, tMinutes] = item.timeStr.split(':').map(Number);
            
            let target = new Date();
            
            if (item.type === 'one-time') {
                const [y, m, d] = item.dateStr.split('-').map(Number);
                target = new Date(y, m-1, d);
                target.setHours(tHours, tMinutes, 0, 0);
                return target;
            }

            // Repeating Logic
            const freq = item.freqConfig;
            target.setHours(tHours, tMinutes, 0, 0);

            if (freq.type === 'daily') {
                if (target <= now) {
                    target.setDate(target.getDate() + 1);
                }
            }
            else if (freq.type === 'weekly') {
                const targetDays = freq.days.map(Number);
                let found = false;

                for(let i=0; i<8; i++) {
                    let checkDate = new Date(now);
                    checkDate.setDate(now.getDate() + i);
                    checkDate.setHours(tHours, tMinutes, 0, 0);

                    const isToday = i === 0;
                    const isTargetDay = targetDays.includes(checkDate.getDay());
                    const isFutureTime = checkDate > now;

                    if (isTargetDay && (isFutureTime || !isToday)) {
                        target = checkDate;
                        found = true;
                        break;
                    }
                }
                if (!found) target = null;
            }
            else if (freq.type === 'monthly') {
                let setDay = parseInt(item.dateStr.split('-')[2]); 
                target.setDate(setDay);
                target.setFullYear(now.getFullYear(), now.getMonth());

                if (target <= now) {
                    target.setMonth(target.getMonth() + 1);
                    while (target.getDate() !== setDay && target.getMonth() !== (now.getMonth() + 2) % 12) {
                        target.setDate(target.getDate() - 1);
                    }
                }
            }
            else if (freq.type === 'yearly') {
                let [y, m, d] = item.dateStr.split('-').map(Number);
                target.setMonth(m - 1);
                target.setDate(d);
                target.setFullYear(now.getFullYear());
                target.setHours(tHours, tMinutes, 0, 0);

                if (target <= now) {
                    target.setFullYear(now.getFullYear() + 1);
                }
            }

            return target;
        }

        // --- RENDER UI ---
        function renderCountdowns() {
            grid.innerHTML = '';
            if (appState.countdowns.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
                return;
            }
            emptyState.classList.add('hidden');
            emptyState.classList.remove('flex');

            appState.countdowns.forEach(item => {
                const target = getNextOccurrence(item);
                const card = document.createElement('div');
                card.className = 'countdown-card';
                
                const dateStr = target ? target.toLocaleDateString(undefined, { weekday:'short', year:'numeric', month:'short', day:'numeric' }) : 'Invalid';
                const typeIcon = item.type === 'repeating' ? '<i class="fa-solid fa-rotate text-xs"></i>' : '';

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title font-bold">${item.title}</div>
                        <div class="card-meta flex items-center gap-2">${typeIcon} ${dateStr}</div>
                    </div>
                    <div class="time-display" id="timer-${item.id}">Loading...</div>
                    <div class="detail-display" id="detail-${item.id}"></div>
                    <i class="fa-solid fa-trash delete-btn" onclick="deleteCountdown('${item.id}', event)"></i>
                `;
                grid.appendChild(card);
            });
            updateTicks();
        }

        function updateTicks() {
            appState.countdowns.forEach(item => {
                const elTimer = document.getElementById(`timer-${item.id}`);
                const elDetail = document.getElementById(`detail-${item.id}`);
                if (!elTimer) return;

                const target = getNextOccurrence(item);
                if (!target) {
                    elTimer.textContent = "Error";
                    elDetail.textContent = "Check configuration";
                    elTimer.style.color = "#ef4444";
                    return;
                }

                const d = getDuration(target);

                if (d.passed) {
                    elTimer.textContent = "Completed";
                    elTimer.style.color = "#10b981";
                    elDetail.textContent = item.type === 'one-time' ? "This event has passed." : "Recalculating...";
                    if (item.type === 'repeating') {
                         setTimeout(renderCountdowns, 50); 
                    }
                } else {
                    elTimer.style.color = "var(--tab-active-text)";
                    const h = String(d.hours).padStart(2, '0');
                    const m = String(d.minutes).padStart(2, '0');
                    const s = String(d.seconds).padStart(2, '0');
                    elTimer.textContent = `${h}:${m}:${s}`;
                    
                    let parts = [];
                    if(d.decades > 0) parts.push(`${d.decades} decades`);
                    if(d.years > 0) parts.push(`${d.years} years`);
                    if(d.months > 0) parts.push(`${d.months} months`);
                    if(d.weeks > 0) parts.push(`${d.weeks} weeks`);
                    if(d.days > 0) parts.push(`${d.days} days`);
                    
                    elDetail.textContent = parts.length > 0 ? parts.join(', ') + ' remaining' : 'Less than 24 hours remaining';
                }
            });
        }

        // --- MODAL LOGIC ---
        function openModal(type) {
            currentModalType = type;
            modalTitleText.textContent = type === 'one-time' ? "New One-Time Countdown" : "New Repeating Countdown";
            addDropdown.classList.add('hidden');
            modalOverlay.classList.add('active');
            
            // Reset Inputs
            inpTitle.value = '';
            
            // Set initial date/time values
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            
            inpDate.value = `${yyyy}-${mm}-${dd}`;
            inpTime.value = '12:00'; // internal 24h default (12 PM)
            
            // Initialize displays
            dateDisplay.textContent = formatDisplayDate(inpDate.value);
            timeDisplay.textContent = formatTime12H(12, 0); // "12:00 PM"
            
            if (type === 'repeating') {
                freqSection.classList.remove('hidden');
            } else {
                freqSection.classList.add('hidden');
            }
            
            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
            daysSelector.classList.add('hidden');
            inpFreqType.value = 'daily';

            updatePreview();
        }

        function closeModal() {
            modalOverlay.classList.remove('active');
            datePickerOverlay.classList.remove('active');
            timePickerOverlay.classList.remove('active');
        }

        function updatePreview() {
            const title = inpTitle.value || 'New Event';
            const dateVal = inpDate.value; 
            const timeVal = inpTime.value; // 24H
            
            pTitle.textContent = title;
            
            if (!dateVal || !timeVal) {
                pBigTime.textContent = "---";
                pDateStr.textContent = "---";
                return;
            }

            // Format preview text for human reading
            const [h, m] = timeVal.split(':').map(Number);
            const friendlyTime = formatTime12H(h, m);
            pDateStr.textContent = `${formatDisplayDate(dateVal)} @ ${friendlyTime}`;

            let freqConfig = null;
            if (currentModalType === 'repeating') {
                freqConfig = { type: inpFreqType.value, days: [] };
                if (inpFreqType.value === 'weekly') {
                    document.querySelectorAll('.day-checkbox:checked').forEach(cb => freqConfig.days.push(cb.value));
                }
            }

            const tempItem = {
                type: currentModalType,
                dateStr: dateVal,
                timeStr: timeVal,
                freqConfig: freqConfig
            };

            const target = getNextOccurrence(tempItem);
            if(!target) {
                pBigTime.textContent = "Error";
                return;
            }

            const d = getDuration(target);
            
            if (d.passed) {
                pBigTime.textContent = "Passed";
                pDec.textContent = pYrs.textContent = pMos.textContent = pWks.textContent = pDays.textContent = 0;
            } else {
                pBigTime.textContent = `${String(d.hours).padStart(2,'0')}:${String(d.minutes).padStart(2,'0')}:${String(d.seconds).padStart(2,'0')}`;
                pDec.textContent = d.decades;
                pYrs.textContent = d.years;
                pMos.textContent = d.months;
                pWks.textContent = d.weeks;
                pDays.textContent = d.days;
            }
        }

        // --- EVENT LISTENERS ---
        addMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            addDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!addMenuBtn.contains(e.target) && !addDropdown.contains(e.target)) {
                addDropdown.classList.add('hidden');
            }
        });

        document.getElementById('btn-add-one-time').addEventListener('click', () => openModal('one-time'));
        document.getElementById('btn-add-repeating').addEventListener('click', () => openModal('repeating'));
        
        btnCancel.addEventListener('click', closeModal);

        // Input Watchers
        inpTitle.addEventListener('input', updatePreview);

        inpFreqType.addEventListener('change', () => {
            if (inpFreqType.value === 'weekly') {
                daysSelector.classList.remove('hidden');
            } else {
                daysSelector.classList.add('hidden');
            }
            updatePreview();
        });
        
        document.querySelectorAll('.day-checkbox').forEach(cb => cb.addEventListener('change', updatePreview));

        setInterval(() => {
            if (modalOverlay.classList.contains('active')) updatePreview();
        }, 1000);

        // Save Action
        btnSave.addEventListener('click', () => {
            const title = inpTitle.value || 'Untitled';
            const dateStr = inpDate.value;
            const timeStr = inpTime.value;

            if (!dateStr || !timeStr) {
                console.error("Please select a valid date and time before saving.");
                return;
            }

            let freqConfig = null;
            if (currentModalType === 'repeating') {
                freqConfig = { type: inpFreqType.value, days: [] };
                if (inpFreqType.value === 'weekly') {
                    document.querySelectorAll('.day-checkbox:checked').forEach(cb => freqConfig.days.push(cb.value));
                }
            }

            const newItem = {
                id: Date.now().toString(),
                title,
                type: currentModalType,
                dateStr,
                timeStr,
                freqConfig
            };

            appState.countdowns.push(newItem);
            idbCountdowns.save(appState.countdowns);
            renderCountdowns();
            closeModal();
        });

        setInterval(updateTicks, 1000);

        window.deleteCountdown = (id, event) => {
            event.stopPropagation();
            appState.countdowns = appState.countdowns.filter(c => c.id !== id);
            idbCountdowns.save(appState.countdowns);
            renderCountdowns();
        };

        // --- INIT ---
        window.addEventListener('load', async () => {
            initPickers(); 
            await idbCountdowns.initDB();
            const saved = await idbCountdowns.load();
            if (saved) appState.countdowns = saved;
            renderCountdowns();
        });

    </script>
</body>
</html>
