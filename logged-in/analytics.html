<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - ANALYTICS</title>
    <meta name="description" content="Admin analytics dashboard for 4SP.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

    <style>
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: var(--navbar-bg); 
            color: var(--menu-text); 
            transition: all 0.3s ease;
            font-size: 16px;
            overflow-x: hidden;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        .user-table, .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .user-table th, .user-table td, .analytics-table th, .analytics-table td {
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #1a1a1a;
        }
        .user-table th, .analytics-table th {
            color: #707070;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        .user-table tr:hover, .analytics-table tr:hover {
            background-color: #0d0d0d;
        }

        .provider-icon {
            width: 1.25rem;
            height: 1.25rem;
            object-fit: contain;
        }

        .action-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        .btn-block {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        .btn-block:hover {
            background-color: rgba(239, 68, 68, 0.2);
        }
        .btn-unblock {
            background-color: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        .btn-unblock:hover {
            background-color: rgba(34, 197, 94, 0.2);
        }
        .btn-admin {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .btn-admin:hover {
            background-color: rgba(59, 130, 246, 0.2);
        }
        .btn-remove-admin {
            background-color: rgba(234, 179, 8, 0.1);
            color: #eab308;
            border: 1px solid rgba(234, 179, 8, 0.2);
        }
        .btn-remove-admin:hover {
            background-color: rgba(234, 179, 8, 0.2);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: #0d0d0d;
            border: 1px solid #333;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
        }

        .chart-container {
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            padding: 1rem;
            height: 300px;
            margin-bottom: 2rem;
        }
        
        .preset-chip {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 1rem;
            color: #9ca3af;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .preset-chip:hover {
            background: #2a2a2a;
            color: white;
            border-color: #555;
        }

        .tab-btn {
            background: transparent;
            color: #707070;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: white;
            border-bottom-color: #3b82f6;
        }
        
        .alert-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* Theme Overrides */
        .bg-theme-page { background-color: var(--navbar-bg) !important; }
        .bg-theme-menu { background-color: var(--menu-bg) !important; }
        .border-theme { border-color: var(--navbar-border) !important; }
        .text-theme { color: var(--menu-text) !important; }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div id="page-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8">
        
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Analytics</h1>
                <p class="text-gray-400">System overview and user management.</p>
            </div>
            <div class="flex gap-4 border-b border-theme w-full sm:w-auto overflow-x-auto">
                <button class="tab-btn active whitespace-nowrap" data-tab="users">User Management</button>
                <button class="tab-btn whitespace-nowrap" data-tab="traffic">Site Traffic</button>
                <button class="tab-btn whitespace-nowrap" data-tab="health">System Health</button>
            </div>
        </header>

        <!-- USER MANAGEMENT TAB -->
        <div id="tab-users" class="tab-content">
            <!-- Charts Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="chart-container">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-lg">New Users</h3>
                        <select id="chart-period" class="bg-[#1a1a1a] text-gray-300 border border-theme rounded px-2 py-1 text-sm focus:outline-none">
                            <option value="week">Past Week</option>
                            <option value="month" selected>Past Month</option>
                            <option value="year">Past Year</option>
                        </select>
                    </div>
                    <div class="relative h-full w-full" style="height: 220px;">
                        <canvas id="userGrowthChart"></canvas>
                    </div>
                </div>
                
                 <div class="grid grid-cols-2 gap-4 h-full">
                    <div class="bg-theme-menu border border-theme rounded-xl p-6 flex flex-col justify-center items-center">
                        <span class="text-gray-400 text-sm mb-2">Total Users</span>
                        <span id="total-users-count" class="text-4xl text-white font-light">--</span>
                    </div>
                    <div class="bg-theme-menu border border-theme rounded-xl p-6 flex flex-col justify-center items-center">
                        <span class="text-gray-400 text-sm mb-2">Admins</span>
                        <span id="total-admins-count" class="text-4xl text-blue-400 font-light">--</span>
                    </div>
                     <div class="bg-theme-menu border border-theme rounded-xl p-6 flex flex-col justify-center items-center">
                        <span class="text-gray-400 text-sm mb-2">Banned</span>
                        <span id="total-banned-count" class="text-4xl text-red-400 font-light">--</span>
                    </div>
                     <div class="bg-theme-menu border border-theme rounded-xl p-6 flex flex-col justify-center items-center">
                        <span class="text-gray-400 text-sm mb-2">Reports</span>
                        <span id="total-reports-count" class="text-4xl text-yellow-400 font-light">0</span>
                    </div>
                 </div>
            </div>

            <!-- User List Section -->
            <div class="bg-theme-menu border border-theme rounded-xl overflow-hidden">
                <div class="p-4 border-b border-theme flex justify-between items-center flex-wrap gap-4">
                    <h3 class="text-white text-lg">User Directory</h3>
                    <div class="flex gap-4">
                        <input type="text" id="user-search" placeholder="Search users..." class="bg-[#1a1a1a] text-white border border-theme rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-blue-500 w-64">
                        <select id="user-sort" class="bg-[#1a1a1a] text-gray-300 border border-theme rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="admin">Admins First</option>
                        </select>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Provider</th>
                                <th>Joined</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                </div>
                <div id="loading-users" class="p-8 text-center text-gray-500">
                    <i class="fa-solid fa-spinner fa-spin mr-2"></i> Loading users...
                </div>
            </div>
        </div>

        <!-- TRAFFIC TAB -->
        <div id="tab-traffic" class="tab-content hidden">
            <!-- Traffic Overview -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                 <div class="bg-theme-menu border border-theme rounded-xl p-6">
                    <div class="text-gray-400 text-sm mb-2">Total Sessions</div>
                    <div id="stat-total-sessions" class="text-3xl text-white font-light">--</div>
                </div>
                <div class="bg-theme-menu border border-theme rounded-xl p-6">
                    <div class="text-gray-400 text-sm mb-2">Avg Duration</div>
                    <div id="stat-avg-duration" class="text-3xl text-blue-400 font-light">--</div>
                </div>
                 <div class="bg-theme-menu border border-theme rounded-xl p-6">
                    <div class="text-gray-400 text-sm mb-2">Total Page Views</div>
                    <div id="stat-total-views" class="text-3xl text-purple-400 font-light">--</div>
                </div>
                 <div class="bg-theme-menu border border-theme rounded-xl p-6">
                    <div class="text-gray-400 text-sm mb-2">Active (24h)</div>
                    <div id="stat-active-24h" class="text-3xl text-green-400 font-light">--</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Most Visited Pages -->
                <div class="bg-theme-menu border border-theme rounded-xl overflow-hidden h-fit">
                    <div class="p-4 border-b border-theme">
                        <h3 class="text-white text-lg">Top Pages</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>Page Path</th>
                                    <th>Title</th>
                                    <th class="text-right">Visits</th>
                                </tr>
                            </thead>
                            <tbody id="top-pages-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Sessions -->
                <div class="bg-theme-menu border border-theme rounded-xl overflow-hidden h-fit">
                    <div class="p-4 border-b border-theme">
                         <h3 class="text-white text-lg">Recent Sessions</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>User / Email</th>
                                    <th>Start Time</th>
                                    <th>Duration</th>
                                    <th>Pages</th>
                                </tr>
                            </thead>
                            <tbody id="recent-sessions-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
             <div id="loading-traffic" class="p-8 text-center text-gray-500">
                <i class="fa-solid fa-spinner fa-spin mr-2"></i> Loading analytics data...
            </div>
        </div>

        <!-- SYSTEM HEALTH TAB -->
        <div id="tab-health" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Browser Distribution -->
                <div class="chart-container">
                    <h3 class="text-white text-lg mb-4">Browser Distribution</h3>
                    <div class="relative h-full w-full" style="height: 220px;">
                        <canvas id="browserChart"></canvas>
                    </div>
                </div>
                <!-- OS Distribution -->
                 <div class="chart-container">
                    <h3 class="text-white text-lg mb-4">OS Distribution</h3>
                    <div class="relative h-full w-full" style="height: 220px;">
                        <canvas id="osChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Bugged Docs Section -->
            <div class="bg-theme-menu border border-theme rounded-xl overflow-hidden">
                <div class="p-4 border-b border-theme">
                    <h3 class="text-white text-lg">Data Integrity</h3>
                    <p class="text-sm text-gray-500">Potential orphaned documents or incomplete records.</p>
                </div>
                <div class="p-4">
                    <div id="integrity-status" class="text-sm text-gray-400 mb-4">Scanning...</div>
                    <div class="overflow-x-auto">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>Document ID</th>
                                    <th>Issue Type</th>
                                    <th>Details</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="integrity-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- User Details Modal -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-xl text-white">User Details</h3>
                <button id="close-user-modal" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div id="user-modal-body" class="space-y-4"></div>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div id="ban-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-xl text-white">Ban User</h3>
                <button id="close-ban-modal" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-400 text-sm" id="ban-user-target">Banning user: ...</p>
                
                <div>
                    <label class="block text-sm text-gray-500 mb-2">Presets</label>
                    <div class="flex flex-wrap gap-2">
                        <button class="preset-chip" data-reason="Violation of Terms of Service" data-link="../legal.html">Terms of Service</button>
                        <button class="preset-chip" data-reason="Posting Explicit Content on Dailyphoto">Explicit Content</button>
                        <button class="preset-chip" data-reason="Spamming or Harassment">Spam/Harassment</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm text-gray-500 mb-2">Reason (Optional)</label>
                    <textarea id="ban-reason" class="w-full bg-[#1a1a1a] text-white border border-theme rounded-lg p-3 text-sm focus:outline-none focus:border-red-500 min-h-[100px]" placeholder="Enter reason for ban..."></textarea>
                </div>
                
                <input type="hidden" id="ban-link" value="">

                <div class="flex justify-end gap-3 mt-6">
                    <button id="cancel-ban" class="px-4 py-2 text-gray-400 hover:text-white text-sm">Cancel</button>
                    <button id="confirm-ban" class="px-6 py-2 bg-red-900/50 hover:bg-red-800 text-red-200 border border-red-700 rounded-lg text-sm transition">Ban User</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc,
            updateDoc,
            query,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { firebaseConfig } from "../firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allUsers = [];
        let allSessions = [];
        let admins = new Set();
        let bannedUsers = new Set();
        let chartInstance = null;
        let browserChartInstance = null;
        let osChartInstance = null;
        let userToBan = null;

        const providerImages = {
            'google.com': '../images/google-icon.png',
            'microsoft.com': '../images/microsoft.png',
            'github.com': '../images/github-mark-white.png',
            'twitter.com': '../images/x.png',
            'password': 'fa-solid fa-envelope'
        };

        const init = async () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const adminDoc = await getDoc(doc(db, 'admins', user.uid));
                    const isSuperAdmin = user.email === '4simpleproblems@gmail.com';
                    
                    if (adminDoc.exists() || isSuperAdmin) {
                        await loadUserData();
                        loadTrafficData();
                        runIntegrityCheck();
                    } else {
                        window.location.href = '../logged-in/dashboard.html';
                    }
                } else {
                    window.location.href = '../index.html';
                }
            });
            
            setupTabs();
        };

        const setupTabs = () => {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    
                    btn.classList.add('active');
                    const tabId = btn.dataset.tab;
                    document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                });
            });
        };

        const loadUserData = async () => {
            try {
                const adminsSnap = await getDocs(collection(db, 'admins'));
                admins = new Set(adminsSnap.docs.map(d => d.id));
                document.getElementById('total-admins-count').textContent = admins.size;

                const bansSnap = await getDocs(collection(db, 'bans'));
                bannedUsers = new Set(bansSnap.docs.map(d => d.id));
                document.getElementById('total-banned-count').textContent = bannedUsers.size;

                const usersSnap = await getDocs(query(collection(db, 'users'), orderBy('createdAt', 'desc')));
                allUsers = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                document.getElementById('total-users-count').textContent = allUsers.length;
                document.getElementById('loading-users').style.display = 'none';

                renderTable(allUsers);
                renderChart(allUsers);
                
            } catch (error) {
                console.error("Error loading user data:", error);
                document.getElementById('loading-users').textContent = "Error loading data.";
            }
        };

        const loadTrafficData = async () => {
            try {
                // Fetch all recent sessions (limit to 200 for perf)
                const q = query(collection(db, 'analytics'), orderBy('lastActive', 'desc'), limit(200));
                const snap = await getDocs(q);
                allSessions = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                if (allSessions.length === 0) {
                    document.getElementById('loading-traffic').textContent = "No traffic data available.";
                    return;
                }

                // --- Calculate Stats ---
                const totalSessions = allSessions.length; 
                let totalDuration = 0;
                let totalPageViews = 0;
                let active24h = 0;
                const pageCounts = {};
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                const browsers = {};
                const os = {};

                allSessions.forEach(s => {
                    totalDuration += (s.duration || 0);
                    
                    // Parse Pages
                    if (s.visitedPages && Array.isArray(s.visitedPages)) {
                        totalPageViews += s.visitedPages.length;
                        s.visitedPages.forEach(p => {
                            const path = p.path || p; 
                            const title = p.title || path;
                            if (!pageCounts[path]) pageCounts[path] = { count: 0, title: title };
                            pageCounts[path].count++;
                        });
                    } else if (s.pageCount) {
                        totalPageViews += s.pageCount;
                    }

                    // Parse User Agent
                    if (s.userAgent) {
                        const ua = parseUserAgent(s.userAgent);
                        browsers[ua.browser] = (browsers[ua.browser] || 0) + 1;
                        os[ua.os] = (os[ua.os] || 0) + 1;
                    }

                    // Check last active
                    const lastActive = s.lastActive && s.lastActive.toDate ? s.lastActive.toDate().getTime() : 0;
                    if (now - lastActive < oneDay) active24h++;
                });

                const avgDuration = totalSessions > 0 ? (totalDuration / totalSessions).toFixed(1) : 0;

                // --- Render Top Stats ---
                document.getElementById('stat-total-sessions').textContent = totalSessions + (allSessions.length === 200 ? '+' : '');
                document.getElementById('stat-avg-duration').textContent = formatDuration(avgDuration);
                document.getElementById('stat-total-views').textContent = totalPageViews;
                document.getElementById('stat-active-24h').textContent = active24h;

                // --- Render Top Pages ---
                const sortedPages = Object.values(pageCounts).sort((a, b) => b.count - a.count).slice(0, 10);
                const pagesBody = document.getElementById('top-pages-body');
                pagesBody.innerHTML = sortedPages.map(p => `
                    <tr>
                        <td class="text-xs font-mono text-gray-500 truncate max-w-[150px]">${p.title}</td>
                         <td class="text-white">${p.title}</td>
                        <td class="text-right text-gray-300">${p.count}</td>
                    </tr>
                `).join('');

                // --- Render Recent Sessions (Updated) ---
                const sessionsBody = document.getElementById('recent-sessions-body');
                sessionsBody.innerHTML = allSessions.slice(0, 15).map(s => {
                    let displayName = 'Guest';
                    let displayEmail = '-';
                    let userClass = 'text-gray-500';

                    if (s.userId && s.userId !== 'anonymous') {
                        const matchedUser = allUsers.find(u => u.id === s.userId);
                        if (matchedUser) {
                            displayName = matchedUser.username || 'Unknown Name';
                            displayEmail = matchedUser.email || 'No Email';
                            userClass = 'text-blue-400 font-medium';
                        } else {
                            displayName = 'Orphaned ID';
                            displayEmail = s.userId;
                            userClass = 'text-red-400 font-mono text-xs';
                        }
                    }

                    return `
                    <tr>
                        <td>
                            <div class="flex flex-col">
                                <span class="${userClass}">${displayName}</span>
                                <span class="text-xs text-gray-600">${displayEmail}</span>
                            </div>
                        </td>
                        <td class="text-gray-400 text-sm">${formatTimeAgo(s.startTime)}</td>
                        <td class="text-gray-300 text-sm">${formatDuration(s.duration)}</td>
                        <td class="text-gray-400 text-sm">${s.visitedPages ? s.visitedPages.length : (s.pageCount || 0)}</td>
                    </tr>
                `}).join('');

                document.getElementById('loading-traffic').style.display = 'none';

                // --- Render Health Charts ---
                renderPieChart('browserChart', browsers, 'Browsers');
                renderPieChart('osChart', os, 'Operating Systems');

            } catch (error) {
                console.error("Error loading traffic data:", error);
                document.getElementById('loading-traffic').textContent = "Error loading analytics.";
            }
        };

        const runIntegrityCheck = async () => {
            const tbody = document.getElementById('integrity-table-body');
            const statusDiv = document.getElementById('integrity-status');
            tbody.innerHTML = '';
            let issuesFound = 0;

            // 1. Check for Malformed User Docs (Missing Email/Username)
            allUsers.forEach(user => {
                let issues = [];
                if (!user.email) issues.push('Missing Email');
                if (!user.username) issues.push('Missing Username');
                if (!user.authMethod) issues.push('Missing AuthMethod');

                if (issues.length > 0) {
                    issuesFound++;
                    addIntegrityRow(user.id, 'Incomplete User Record', issues.join(', '), 'delete-user');
                }
            });

            // 2. Check for Orphaned Analytics (Session ID not in Users)
            // Note: Only checking loaded sessions to save reads
            allSessions.forEach(s => {
                if (s.userId && s.userId !== 'anonymous') {
                    const userExists = allUsers.some(u => u.id === s.userId);
                    if (!userExists) {
                         issuesFound++;
                         addIntegrityRow(s.id, 'Orphaned Analytics', `User ID ${s.userId} not found in DB`, 'delete-session');
                    }
                }
            });

            statusDiv.textContent = issuesFound > 0 
                ? `Found ${issuesFound} potential data integrity issues.` 
                : 'No data integrity issues found.';
        };

        const addIntegrityRow = (id, type, details, actionType) => {
            const tbody = document.getElementById('integrity-table-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="font-mono text-xs text-gray-500">${id}</td>
                <td class="text-orange-400">${type}</td>
                <td class="text-sm text-gray-400">${details}</td>
                <td>
                    <button class="text-xs bg-red-900/30 border border-red-500/30 text-red-400 px-2 py-1 rounded hover:bg-red-900/50" onclick="alert('Manual deletion required via Firebase Console for safety.')">
                        Review
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        };

        // --- Helpers ---

        const parseUserAgent = (ua) => {
            let browser = 'Unknown';
            let os = 'Unknown';

            if (ua.includes('Firefox')) browser = 'Firefox';
            else if (ua.includes('Chrome')) browser = 'Chrome';
            else if (ua.includes('Safari')) browser = 'Safari';
            else if (ua.includes('Edge')) browser = 'Edge';

            if (ua.includes('Windows')) os = 'Windows';
            else if (ua.includes('Mac')) os = 'MacOS';
            else if (ua.includes('Linux')) os = 'Linux';
            else if (ua.includes('Android')) os = 'Android';
            else if (ua.includes('iPhone') || ua.includes('iPad')) os = 'iOS';

            return { browser, os };
        };

        const formatDuration = (seconds) => {
            if (!seconds) return '0s';
            if (seconds < 60) return `${Math.floor(seconds)}s`;
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}m ${s}s`;
        };

        const formatTimeAgo = (timestamp) => {
            if (!timestamp) return '-';
            return moment(timestamp).fromNow();
        };

        const getProviderHtml = (authMethod) => {
            if (!authMethod) return '<span class="text-gray-500">-</span>';
            let key = authMethod;
            if (authMethod.includes('google')) key = 'google.com';
            if (authMethod.includes('github')) key = 'github.com';
            if (authMethod.includes('microsoft')) key = 'microsoft.com';
            if (authMethod.includes('twitter')) key = 'twitter.com';
            if (authMethod === 'email') key = 'password';

            const img = providerImages[key];
            if (!img) return `<span class="text-xs text-gray-500">${authMethod}</span>`;
            
            if (img.startsWith('fa-')) {
                return `<i class="${img} text-gray-400"></i>`;
            } else {
                return `<img src="${img}" class="provider-icon" title="${authMethod}">`;
            }
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'Unknown';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString();
        };

        const renderTable = (users) => {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">No users found.</td></tr>';
                return;
            }

            users.forEach(user => {
                const tr = document.createElement('tr');
                const isAdmin = admins.has(user.id);
                const isBanned = bannedUsers.has(user.id);
                
                const roleBadge = isAdmin 
                    ? `<span class="bg-blue-900/30 text-blue-400 text-xs px-2 py-1 rounded border border-blue-500/30">Admin</span>`
                    : `<span class="text-gray-500 text-xs">User</span>`;

                const statusBadge = isBanned
                    ? `<span class="bg-red-900/30 text-red-400 text-xs px-2 py-1 rounded border border-red-500/30">Banned</span>`
                    : `<span class="text-green-500/70 text-xs">Active</span>`;

                tr.innerHTML = `
                    <td>
                        <div class="flex flex-col">
                            <span class="text-white font-medium">${user.username || 'Unknown'}</span>
                            <span class="text-xs text-gray-600">${user.email || user.id}</span>
                        </div>
                    </td>
                    <td>${getProviderHtml(user.authMethod)}</td>
                    <td class="text-gray-400 text-sm">${formatDate(user.createdAt)}</td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="flex items-center">
                            <button class="action-btn ${isBanned ? 'btn-unblock' : 'btn-block'}" data-action="toggle-ban" data-uid="${user.id}" data-username="${user.username || user.email}">
                                ${isBanned ? '<i class="fa-solid fa-unlock"></i>' : '<i class="fa-solid fa-ban"></i>'}
                            </button>
                            <button class="action-btn ${isAdmin ? 'btn-remove-admin' : 'btn-admin'}" data-action="toggle-admin" data-uid="${user.id}">
                                ${isAdmin ? '<i class="fa-solid fa-user-minus"></i>' : '<i class="fa-solid fa-user-shield"></i>'}
                            </button>
                            <button class="action-btn text-gray-400 hover:text-white" data-action="view-details" data-uid="${user.id}">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            tbody.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', handleAction);
            });
        };

        const handleAction = async (e) => {
            const btn = e.currentTarget;
            const action = btn.dataset.action;
            const uid = btn.dataset.uid;
            
            if (action === 'toggle-ban') {
                const isBanned = bannedUsers.has(uid);
                if (isBanned) {
                    if (confirm(`Are you sure you want to unban this user?`)) {
                        try {
                            await deleteDoc(doc(db, 'bans', uid));
                            bannedUsers.delete(uid);
                            renderTable(getFilteredUsers());
                            document.getElementById('total-banned-count').textContent = bannedUsers.size;
                        } catch (err) { alert("Unban failed: " + err.message); }
                    }
                } else {
                    userToBan = { uid, username: btn.dataset.username };
                    openBanModal();
                }
            } else if (action === 'toggle-admin') {
                const isAdmin = admins.has(uid);
                if (confirm(`Are you sure you want to ${isAdmin ? 'remove' : 'grant'} admin privileges?`)) {
                    try {
                         if (isAdmin) {
                            await deleteDoc(doc(db, 'admins', uid));
                            admins.delete(uid);
                        } else {
                            await setDoc(doc(db, 'admins', uid), { 
                                role: 'admin',
                                promotedAt: new Date()
                            });
                            admins.add(uid);
                        }
                        renderTable(getFilteredUsers());
                        document.getElementById('total-admins-count').textContent = admins.size;
                    } catch (err) { alert("Action failed: " + err.message); }
                }
            } else if (action === 'view-details') {
                showUserDetails(uid);
            }
        };

        const openBanModal = () => {
            document.getElementById('ban-user-target').textContent = `Banning user: ${userToBan.username}`;
            document.getElementById('ban-reason').value = '';
            document.getElementById('ban-link').value = '';
            document.getElementById('ban-modal').classList.add('open');
        };

        const closeBanModal = () => {
            document.getElementById('ban-modal').classList.remove('open');
            userToBan = null;
        };

        document.getElementById('close-ban-modal').addEventListener('click', closeBanModal);
        document.getElementById('cancel-ban').addEventListener('click', closeBanModal);
        
        document.querySelectorAll('.preset-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const reason = chip.dataset.reason;
                const link = chip.dataset.link || '';
                document.getElementById('ban-reason').value = reason;
                document.getElementById('ban-link').value = link;
            });
        });

        document.getElementById('confirm-ban').addEventListener('click', async () => {
            if (!userToBan) return;
            const reason = document.getElementById('ban-reason').value.trim() || 'Admin Action';
            const link = document.getElementById('ban-link').value;

            try {
                await setDoc(doc(db, 'bans', userToBan.uid), { 
                    bannedAt: new Date(),
                    reason: reason,
                    link: link || null
                });
                bannedUsers.add(userToBan.uid);
                renderTable(getFilteredUsers());
                document.getElementById('total-banned-count').textContent = bannedUsers.size;
                closeBanModal();
            } catch (err) {
                alert("Ban failed: " + err.message);
            }
        });

        const showUserDetails = (uid) => {
            const user = allUsers.find(u => u.id === uid);
            if (!user) return;

            const modal = document.getElementById('user-modal');
            const body = document.getElementById('user-modal-body');
            
            body.innerHTML = `
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center text-xl font-bold text-white">
                        ${(user.username || 'U').charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <h4 class="text-lg text-white font-medium">${user.username || 'No Username'}</h4>
                        <p class="text-sm text-gray-500">${user.email || 'No Email'}</p>
                        <p class="text-xs text-gray-600 font-mono mt-1">${user.id}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="p-3 bg-[#111] rounded border border-theme">
                        <span class="block text-gray-500 text-xs uppercase mb-1">Created At</span>
                        <span class="text-gray-300">${formatDate(user.createdAt)}</span>
                    </div>
                     <div class="p-3 bg-[#111] rounded border border-theme">
                        <span class="block text-gray-500 text-xs uppercase mb-1">Auth Method</span>
                        <span class="text-gray-300 flex items-center gap-2">
                             ${getProviderHtml(user.authMethod)} ${user.authMethod || 'Unknown'}
                        </span>
                    </div>
                     <div class="p-3 bg-[#111] rounded border border-theme">
                        <span class="block text-gray-500 text-xs uppercase mb-1">Role</span>
                        <span class="text-gray-300">${admins.has(user.id) ? 'Admin' : 'User'}</span>
                    </div>
                    <div class="p-3 bg-[#111] rounded border border-theme">
                        <span class="block text-gray-500 text-xs uppercase mb-1">Status</span>
                        <span class="text-gray-300">${bannedUsers.has(user.id) ? 'Banned' : 'Active'}</span>
                    </div>
                </div>
            `;
            
            modal.classList.add('open');
        };

        document.getElementById('close-user-modal').addEventListener('click', () => {
            document.getElementById('user-modal').classList.remove('open');
        });

        const getFilteredUsers = () => {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const sortVal = document.getElementById('user-sort').value;

            let filtered = allUsers.filter(u => 
                (u.username && u.username.toLowerCase().includes(searchTerm)) ||
                (u.email && u.email.toLowerCase().includes(searchTerm)) ||
                u.id.includes(searchTerm)
            );

            filtered.sort((a, b) => {
                const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);

                if (sortVal === 'newest') return dateB - dateA;
                if (sortVal === 'oldest') return dateA - dateB;
                if (sortVal === 'admin') {
                    const isAdminA = admins.has(a.id) ? 1 : 0;
                    const isAdminB = admins.has(b.id) ? 1 : 0;
                    return isAdminB - isAdminA || dateB - dateA;
                }
                return 0;
            });

            return filtered;
        };

        document.getElementById('user-search').addEventListener('input', () => renderTable(getFilteredUsers()));
        document.getElementById('user-sort').addEventListener('change', () => renderTable(getFilteredUsers()));

        const renderChart = (users) => {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            const period = document.getElementById('chart-period').value;

            const now = moment();
            let startDate;
            let unit;

            if (period === 'week') {
                startDate = moment().subtract(7, 'days');
                unit = 'day';
            } else if (period === 'month') {
                startDate = moment().subtract(1, 'month');
                unit = 'day';
            } else {
                startDate = moment().subtract(1, 'year');
                unit = 'month';
            }

            const groups = {};
            if (period === 'year') {
                for (let i = 0; i <= 12; i++) {
                    const d = moment().subtract(i, 'months').format('YYYY-MM');
                    groups[d] = 0;
                }
            } else {
                const days = period === 'week' ? 7 : 30;
                for (let i = 0; i <= days; i++) {
                    const d = moment().subtract(i, 'days').format('YYYY-MM-DD');
                    groups[d] = 0;
                }
            }

            users.forEach(u => {
                if (!u.createdAt) return;
                const d = u.createdAt.toDate ? moment(u.createdAt.toDate()) : moment(u.createdAt);
                if (d.isAfter(startDate)) {
                    const key = unit === 'month' ? d.format('YYYY-MM') : d.format('YYYY-MM-DD');
                    if (groups[key] !== undefined) groups[key]++;
                }
            });

            const labels = Object.keys(groups).sort();
            const data = labels.map(l => groups[l]);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Users',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#040404',
                        pointBorderColor: '#3b82f6',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: unit,
                                tooltipFormat: unit === 'month' ? 'MMM YYYY' : 'MMM DD'
                            },
                            grid: { color: '#1a1a1a' },
                            ticks: { color: '#707070' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#1a1a1a' },
                            ticks: { color: '#707070', stepSize: 1 }
                        }
                    }
                }
            });
        };
        
        const renderPieChart = (canvasId, dataMap, label) => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = Object.keys(dataMap);
            const data = Object.values(dataMap);
            const colors = [
                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6366f1'
            ];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#9ca3af' } }
                    }
                }
            });
        };

        document.getElementById('chart-period').addEventListener('change', () => renderChart(allUsers));

        init();
    </script>
</body>
</html>